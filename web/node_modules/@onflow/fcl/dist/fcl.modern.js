import{config as e}from"@onflow/config";export{config}from"@onflow/config";import{resolve as t,send as n,script as a,args as r,limit as s,decode as o,arg as i,pipe as c,interaction as u,getTransactionStatus as d,latestBlock as l}from"@onflow/sdk";export{account,arg,args,atBlockHeight,atBlockId,authorization,authorizations,build,decode,getAccount,getBlock,getBlockByHeight,getBlockById,getBlockHeader,getCollection,getEvents,getEventsAtBlockHeightRange,getEventsAtBlockIds,getLatestBlock,getTransaction,getTransactionStatus,invariant,isBad,isOk,latestBlock,limit,param,params,payer,ping,pipe,proposer,ref,script,send,transaction,validator,why}from"@onflow/sdk";import{invariant as p}from"@onflow/util-invariant";import*as f from"@onflow/types";import{subscriber as y,spawn as h,snapshoter as m,INIT as g,SUBSCRIBE as w,UPDATED as E,UNSUBSCRIBE as v,SNAPSHOT as R,send as S}from"@onflow/util-actor";import{withPrefix as b,sansPrefix as P}from"@onflow/util-address";export{display,sansPrefix,withPrefix}from"@onflow/util-address";import{encode as T}from"@onflow/rlp";import{uid as I}from"@onflow/util-uid";export{template as cadence,template as cdc}from"@onflow/util-template";e().put("accessNode.api","http://localhost:8080").put("challenge.handshake","http://localhost:8700/authenticate"),e().put("sdk.resolve",t);const C="0.0.70";async function k(e={}){return await async function(e){p(null!=typeof e.cadence,"query({ cadence }) -- cadence is required"),p((e=>"string"==typeof e)(e.cadence),"query({ cadence }) -- cadence must be a string")}(e),n([a(e.cadence),r((t=e.args||[],"function"==typeof t?t(i,f):[])),e.limit&&"number"==typeof e.limit&&s(e.limit)]).then(o);var t}const A=async(n=[],a={})=>{const r=await e().get("sdk.resolve",a.resolve||t(a));return Array.isArray(n)&&(n=await c(u(),n)),JSON.stringify(await r(n),null,2)},N=async e=>n([d(e)]).then(o),O=e=>e.status>=4,_=e=>e.status>=3,L=e=>e.status>=2,x={[g]:async e=>{const t=await N(e.self());O(t)||setTimeout(()=>e.sendSelf("POLL"),2500),e.merge(t)},[w]:(e,t)=>{e.subscribe(t.from),e.send(t.from,E,e.all())},[v]:(e,t)=>{e.unsubscribe(t.from)},[R]:async(e,t)=>{t.reply(e.all())},POLL:async e=>{const t=await N(e.self());var n,a;O(t)||setTimeout(()=>e.sendSelf("POLL"),2500),n=e.all(),a=t,JSON.stringify(n)!==JSON.stringify(a)&&e.broadcast(E,t),e.merge(t)}},U=e=>{if("object"==typeof e&&(e=e.transactionId),null==e)throw new Error("transactionId required");return e},D=e=>h(x,U(e));function z(e){function t(t){return y(U(e),D,t)}function n(e){return function(n={}){const a=n.suppress||!1;return new Promise((n,r)=>{const s=t(t=>{t.statusCode&&!a?(r(t.errorMessage),s()):e(t)&&(n(t),s())})})}}return{snapshot:function(){return m(e,D)},subscribe:t,onceFinalized:n(L),onceExecuted:n(_),onceSealed:n(O)}}z.isUnknown=e=>e.status>=0,z.isPending=e=>e.status>=1,z.isFinalized=L,z.isExecuted=_,z.isSealed=O,z.isExpired=e=>5===e.status;const F=async t=>setTimeout(()=>t.sendSelf("TICK"),await e().get("fcl.eventPollRate",1e4)),H={TICK:async e=>{if(!e.hasSubs())return;let t=e.get("hwm");if(null==t)e.put("hwm",await l()),e.put("tick",await F(e));else{let a=await l();e.put("hwm",a);const r=await n([getEvents(e.self(),t.height,a.height-1)]).then(o);for(let t of r)e.broadcast("UPDATED",t.data);e.put("tick",await F(e))}},[w]:async(e,t)=>{e.hasSubs()||e.put("tick",await F(e)),e.subscribe(t.from)},[v]:(e,t)=>{e.unsubscribe(t.from),e.hasSubs()||(clearTimeout(e.get("tick")),e.delete("tick"),e.delete("hwm"))}},B=e=>h(H,e);function j(e){return{subscribe:t=>y(e,B,t)}}function M(){return(M=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}const J={f_type:"Service",f_vsn:"1.0.0"},G={f_type:"Identity",f_vsn:"1.0.0"},q={f_type:"USER",f_vsn:"1.0.0"},Y={f_type:"PollingResponse",f_vsn:"1.0.0"},V={f_type:"CompositeSignature",f_vsn:"1.0.0"};function Z(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return M({old:e},J,{type:"frame",endpoint:e.endpoint,params:e.params||{},data:e.data||{}})}}function K(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return M({},J,{type:"back-channel-rpc",endpoint:e.endpoint,method:e.method,params:e.params||{},data:e.data||{}})}}const X={"back-channel-rpc":K,"pre-authz":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return M({},J,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:M({},G,{address:b(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authz:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return M({},J,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:M({},G,{address:b(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authn:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return M({},J,{type:e.type,uid:e.id,endpoint:e.authn,id:e.pid,provider:{address:b(e.addr),name:e.name,icon:e.icon}})}},frame:Z,"open-id":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return null}}};function W(e){return T([e.provider.address||e.provider.name||"UNSPECIFIED",e.id]).toString("hex")}function $(e=[],t){return e.find(e=>e.type===t)}function Q(e){const t=new URL(e.endpoint);if(t.searchParams.append("l6n",window.location.origin),null!=e.params)for(let[n,a]of Object.entries(e.params||{}))t.searchParams.append(n,a);return t}function ee(e,t={}){const n=t.method||"POST",a="GET"===n?void 0:JSON.stringify(t.data||e.data||{});return fetch(Q(e),{method:n,headers:M({},e.headers||{},t.headers||{},{"Content-Type":"application/json"}),body:a}).then(e=>e.json())}function te(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return M({},Y,{status:e.status,reason:e.reason,data:e.compositeSignature||e.data||{},updates:K(e.authorizationUpdates),local:Z((e.local||[])[0])})}}function ne(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return M({},V,{addr:P(e.addr||e.address),signature:e.signature||e.sig,keyId:e.keyId})}}const ae="FCL_IFRAME",re=()=>{},se=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]);function oe(e,t={}){if(null==e)return{send:re,close:re};const n=t.onClose||re,a=t.onMessage||re,r=t.onReady||re,s=t.onResponse||re;window.addEventListener("message",c);const[o,i]=function(e){p(!document.getElementById(ae),"Attempt at triggering multiple Frames",{src:e});const t=document.createElement("iframe");return t.src=e,t.id=ae,t.allow="usb *",t.frameBorder="0",t.style.cssText="\n  position:fixed;\n  top: 0px;\n  right: 0px;\n  bottom: 0px;\n  left: 0px;\n  height: 100vh;\n  width: 100vw;\n  display:block;\n  background:rgba(0,0,0,0.25);\n  z-index: 2147483647;\n  box-sizing: border-box;\n",document.body.append(t),[t,()=>{document.getElementById(ae)&&document.getElementById(ae).remove()}]}(Q(e));return{send:d,close:u};function c(e){try{if("object"!=typeof e.data)return;if(se.has(e.data.type))return;"FCL:FRAME:CLOSE"===e.data.type&&u(),"FCL:FRAME:READY"===e.data.type&&r(e,{send:d,close:u}),"FCL:FRAME:RESPONSE"===e.data.type&&s(e,{send:d,close:u}),a(e,{send:d,close:u}),"FCL::CHALLENGE::RESPONSE"===e.data.type&&s(e,{send:d,close:u}),"FCL::AUTHZ_READY"===e.data.type&&r(e,{send:d,close:u}),"FCL::CHALLENGE::CANCEL"===e.data.type&&u(),"FCL::CANCEL"===e.data.type&&u()}catch(e){console.error("Frame Callback Error",e),u()}}function u(){try{window.removeEventListener("message",c),i(),n()}catch(e){console.error("Frame Close Error",e)}}function d(e){try{o.contentWindow.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Frame Send Error",e,t)}}}const ie={"HTTP/GET":"GET","HTTP/POST":"POST"},ce=e=>(p(ie[e.method],"Invalid Service Method for type back-channel-rpc",{service:e}),ie[e.method]);async function ue(e,t){t.data=e.data;const n=await ee(e,{data:t}).then(te);if("APPROVED"===n.status)return n.data;if("DECLINED"===n.status)throw new Error("Declined: "+(n.reason||"No reason supplied."));if("PENDING"===n.status){var a=!0;const{close:e}=oe(n.local,{onClose(){a=!1}});return async function e(t,n=(()=>!0)){if(p(t,"Missing Polling Service",{service:t}),!n())throw new Error("Externally Halted");const a=await ee(t,{method:ce(t)}).then(te);switch(a.status){case"APPROVED":return a.data;case"DECLINED":throw new Error("Declined: "+(a.reason||"No reason supplied."));default:return await new Promise(e=>setTimeout(e,500)),e(a.updates,n)}}(n.updates,()=>a).then(t=>(e(),ne(t))).catch(t=>{throw console.error(t),e(),t})}throw console.error("Auto Decline: Invalid Response",{service:e,resp:n}),new Error("Auto Decline: Invalid Response")}const de={"HTTP/RPC":ue,"HTTP/POST":ue,"IFRAME/RPC":function(e,t){return new Promise((n,a)=>{const r=I();t.data=e.data,oe(e,{onReady(n,{send:a}){try{a({jsonrpc:"2.0",id:r,method:"fcl:sign",params:[t,e.params]})}catch(e){throw e}},onClose(){a("Declined: Externally Halted")},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==r)return;const s=te(e.data.result);switch(s.status){case"APPROVED":n(ne(s.data)),t();break;case"DECLINED":a("Declined: "+(s.reason||"No reason supplied")),t();break;default:a("Declined: No reason supplied"),t()}}catch(e){throw console.error("execIframeRPC onMessage error",e),e}}})})}};async function le(e,t){try{return de[e.method](e,t)}catch(n){throw console.error("execService(service, msg)",n,{service:e,msg:t}),n}}const pe="CURRENT_USER",fe="CURRENT_USER/UPDATED",ye='{\n  "f_type": "User",\n  "f_vsn": "1.0.0",\n  "addr":null,\n  "cid":null,\n  "loggedIn":null,\n  "expiresAt":null,\n  "services":[]\n}',he=async e=>(sessionStorage.setItem(pe,JSON.stringify(e)),e),me=()=>e().get("persistSession",!0),ge={[g]:async e=>{if(e.merge(JSON.parse(ye)),await me()){const t=await(async()=>{const e=JSON.parse(ye),t=JSON.parse(sessionStorage.getItem(pe));return null!=t&&e.f_vsn!==t.f_vsn?(sessionStorage.removeItem(pe),e):t||e})();Ee(t)&&e.merge(t)}},[w]:(e,t)=>{e.subscribe(t.from),e.send(t.from,fe,M({},e.all()))},[v]:(e,t)=>{e.unsubscribe(t.from)},SNAPSHOT:async(e,t)=>{t.reply(M({},e.all()))},SET_CURRENT_USER:async(e,t,n)=>{e.merge(n),await me()&&he(e.all()),e.broadcast(fe,M({},e.all()))},DEL_CURRENT_USER:async(e,t)=>{e.merge(JSON.parse(ye)),await me()&&he(e.all()),e.broadcast(fe,M({},e.all()))}},we=()=>h(ge,pe);function Ee(e){return null==e.expiresAt||0===e.expiresAt||e.expiresAt>Date.now()}async function ve(t){return Object.fromEntries(Object.entries(await e().where(t)).map(([e,n])=>[e.replace(t,""),n]))}async function Re(){return new Promise(async(t,n)=>{we();const a=await Te();if(a.loggedIn&&Ee(a))return t(a);oe({endpoint:await e().get("discovery.wallet")||await e().get("challenge.handshake")},{async onReady(e,{send:t}){t({type:"FCL:AUTHN:CONFIG",services:await ve(/^service\./),app:await ve(/^app\.detail\./)})},async onClose(){t(await Te())},async onResponse(e,{close:n}){S(pe,"SET_CURRENT_USER",await async function(e){var t=function(e=[],t=[]){return[...e,...t]}((e=function(e){return e.addr=e.addr?b(e.addr):null,e.paddr=e.paddr?b(e.paddr):null,e}(e)).services||[],await async function(e,t){if(null==e||null==t)return[];const n=new URL(e);n.searchParams.append("code",t);const a=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json());if(Array.isArray(a))return a;const r=[];if(Array.isArray(a.authorizations))for(let e of a.authorizations)r.push(M({type:"authz",keyId:a.keyId},e));return null!=a.provider&&r.push(M({type:"authn",id:"wallet-provider#authn"},a.provider)),r}(e.hks,e.code)).map(t=>function(e,t){try{return X[e.type](e,t)}catch(t){return console.error(`Unrecognized FCL Service Type [${e.type}]`,e,t),e}}(t,e));const n=function(e,t){return t.find(e=>"authn"===e.type)}(0,t);return M({},q,{addr:b(e.addr),cid:W(n),loggedIn:!0,services:t,expiresAt:e.exp})}(e.data)),t(await Te()),n()}})})}function Se(){we(),S(pe,"DEL_CURRENT_USER")}async function be(e){we();const t=await Re(),n=$(t.services,"authz"),a=$(t.services,"pre-authz");return M({},e,a?{tempId:"CURRENT_USER",resolve:async(e,t)=>function(e){const t=(e=>({f_type:"PreAuthzResponse",f_vsn:"1.0.0",proposer:(e||{}).proposer,payer:(e||{}).payer||[],authorization:(e||{}).authorization||[]}))(e),n=[];null!=t.proposer&&n.push(["PROPOSER",t.proposer]);for(let e of t.payer||[])n.push(["PAYER",e]);for(let e of t.authorization||[])n.push(["AUTHORIZER",e]);return n.map(([e,t])=>({tempId:[t.identity.address,t.identity.keyId].join("|"),addr:t.identity.address,keyId:t.identity.keyId,signingFunction:e=>le(t,e),role:{proposer:"PROPOSER"===e,payer:"PAYER"===e,authorizer:"AUTHORIZER"===e}}))}(await le(a,t))}:{tempId:"CURRENT_USER",resolve:null,addr:P(n.identity.address),keyId:n.identity.keyId,sequenceNum:null,signature:null,signingFunction:async e=>le(n,e)})}function Pe(e){we();const t=h(async t=>{for(t.send(pe,w);;){const n=await t.receive();if("@EXIT"===n.tag)return void t.send(pe,v);e(n.data)}});return()=>S(t,"@EXIT")}function Te(){return we(),S(pe,"SNAPSHOT",null,{expectReply:!0,timeout:0})}const Ie=()=>({authenticate:Re,unauthenticate:Se,authorization:be,subscribe:Pe,snapshot:Te}),Ce=()=>Ie().authenticate(),ke=()=>Ie().unauthenticate(),Ae=()=>(Ie().unauthenticate(),Ie().authenticate()),Ne=()=>Ie().authenticate(),Oe=()=>Ie().authenticate(),_e=Ie().authorization,Le=f;export{C as VERSION,Ce as authenticate,_e as authz,Ie as currentUser,j as events,Oe as logIn,k as query,Ae as reauthenticate,A as serialize,Ne as signUp,Le as t,z as tx,ke as unauthenticate};
//# sourceMappingURL=fcl.modern.js.map
